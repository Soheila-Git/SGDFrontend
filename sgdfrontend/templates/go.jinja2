<!DOCTYPE html>

<title>{{display_name}} Gene Ontology Term</title>

{% extends "templates/global_layout.jinja2" %}


{% block body %}

<div id="center_title" class="row">
	<h2><span class="gene_name">{{display_name}}</span> Phenotype</h2>
</div>

<div class="row">
	
<!-- Includes navbar.html into template -->
{% include "templates/navbar.jinja2" %}

<div class="small-12 large-9 columns content-column"> 

<!-- Summary
================================================== -->	
<section id="summary" data-magellan-destination="summary">
	<div class="page-header">
		<h1>Summary</h1>
		<p>{{description}}</p>
	</div>
</section>

<!-- Network Visualization
================================================== -->
<section id="network" data-magellan-destination="network">
	<div class="page-header">
		<h1>Ontology</h1>
		<div class="panel">
			<div id="cy" name="cy" style="width:100%;height:700px"></div>
		</div>
    </div>
</section>

<!-- Genes
================================================== -->
<section id="genes" data-magellan-destination="genes">
	<div class="page-header">
		<h1>Genes <span class="round secondary label"><span id="evidence_header"></span> <small>entries for</small> <span id="gene_header_id"></span> <small>genes</small></span></h1>
		<p id='evidence_message' style='display:none'>No genes curated directly to this term.</p>
		<ul {% if child_count > 1000 or child_count == 0 or count == child_count %} style='display:none' {% endif %} class="button-group radius">
			<li><a disabled="true" id="more_genes_button" class="small button secondary">Show Genes Associated With Child Terms</a></li>
		</ul>
		<div id='evidence_wrapper'>
			<div class="button-bar">
				<ul class="button-group radius">
					<li><a disabled="true" id="evidence_table_download" class="small button secondary"><i class='icon-download-alt'></i> Download</a></li>
				</ul>
						
				<ul class="button-group radius">
					<li><a disabled="true" id="evidence_table_analyze" class="small button secondary"><i class='icon-briefcase'></i> Analyze</a></li>
				</ul>
			</div>
			
			<table class='table table-striped table-bordered table-condensed' id='evidence_table' width="100%">
			<thead>
  			<tr>
  				<th></th>
  				<th>Gene</th>
  				<th>Gene Format Name</th>
  				<th>Gene Ontology Term</th>
  				<th>Qualifier</th>
   				<th>Method</th>
  				<th>Evidence</th>
  				<th>Source</th>
  				<th>Assigned On</th>
    			<th>Reference</th>
  				<th>Relationships</th>
  			</tr>
  			</thead>
			</table>
        </div>
   </div>
      <br>
	<br>
	<br>
	<br>
	<br>
	<br>
</section>

</div>
</div>
{% endblock body %}

{% block scripts %}
<script src="/static/js/cytoscape/cytoscape.min.js"></script>	
<script src="/static/js/cytoscape/arbor.js"></script>
<script src="/static/js/local.js"></script>
<script src="/static/js/go.js"></script>


<script>
	//Set up navbar
	document.getElementById('navbar_title').innerHTML = '<span class="gene_name">{{display_name}}</span><br>GO'
	add_navbar_element('Ontology', 'network');
	add_navbar_element('Genes', 'genes');
	
</script>

<script>
	//Template links and filenames
	var go_details_link = "{{go_details_link}}";
	var go_details_all_link = "{{go_details_all_link}}"
	var ontology_graph_link = "{{ontology_graph_link}}";	
	var download_table_link = "{{download_table_link}}";
	var download_table_filename = "{{go_details_filename}}";
	var analyze_link = "{{analyze_link}}";
	var bioent_display_name = "{{display_name}}";
	var bioent_format_name = "GO";
	var bioent_link = "{{link}}";
	
	//Graph style
	var graph_style = cytoscape.stylesheet()
	.selector('node')
	.css({
		'content': 'data(name)',
		'font-family': 'helvetica',
		'font-size': 14,
		'text-outline-width': 3,
		'text-valign': 'center',
		'width': 30,
		'height': 30,
		'border-color': '#fff',
		'background-color': "grey",
		'text-outline-color': '#fff',
		'color': '#888',
	})
	.selector('edge')
	.css({
		'width': 2,
		'target-arrow-shape': 'triangle',
	})
	.selector("node[sub_type='FOCUS']")
	.css({
		'width': 30,
		'height': 30,
		'background-color': "#fade71",
		'text-outline-color': '#fff',
		'color': '#888',
	})
	.selector("node[sub_type='molecular function']")
	.css(
		{'background-color': "#7FBF7B"
	})
	.selector("node[sub_type='biological process']")
	.css(
		{'background-color': "#AF8DC3"
	})
	.selector("node[sub_type='cellular component']")
	.css(
		{'background-color': "#1F78B4"
	})
	
	var layout = null;
	if(bioent_display_name == 'APO Ontology') {
		layout = {
				"name": "arbor", 
				"liveUpdate": true,
				"ungrabifyWhileSimulating": true, 
				"nodeMass":function(data) {
					if(data.sub_type == 'FOCUS') {
						return 10;
					}
					else {
						return 1;
					}
				},
			};
	}
	else {
		layout = {
				"name": "breadthfirst", 
				"fit": false,
			};
	}
		
	$(document).ready(function() {
		if("{{format_name}}" != 'apo_ontology') {
			//Get evidence data
	  		$.getJSON(go_details_link, function(data) {
	  			var header_id = "evidence_header";
	  			var phenotype_header_id = "gene_header_id";
	  			var table_id = "evidence_table";
	  			var download_button_id = "evidence_table_download";
	  			var analyze_button_id = "evidence_table_analyze";
	  			
	  			var message_id = "evidence_message";
	  			var wrapper_id = "evidence_wrapper";
	  			
	  			if(data.length > 0) {
	  				document.getElementById()
	  				set_up_evidence_table(header_id, phenotype_header_id, table_id, download_button_id, 
	  				download_table_link, download_table_filename, 
	  				analyze_button_id, analyze_link, bioent_display_name, bioent_format_name, bioent_link, false, data);
	  			}
	  			else {
	  				document.getElementById(message_id).style.display = "block";
	  				document.getElementById(wrapper_id).style.display = "none";
	  				document.getElementById(header_id).innerHTML = 0;
	  				document.getElementById(phenotype_header_id).innerHTML = 0;
	  			}
	  			
	  			var child_button_id = "more_genes_button";
	  			var child_button = document.getElementById(child_button_id);
	  			child_button.onclick = function() {
	  				child_button.setAttribute('disabled', 'disabled'); 
	  				set_table_message(table_id, '<center><img src="/static/img/dark-slow-wheel.gif"></center>');
	  				document.getElementById(phenotype_header_id).innerHTML = '_';
					document.getElementById(header_id).innerHTML = '_';
					
					var show_biocon_col = null;
					var data_link = null; 
					var new_message = null;
					
					if(child_button.innerHTML == 'Hide Genes Associated With Child Terms') {
						show_biocon_col = false;
						data_link = go_details_link;
						new_message = 'Show Genes Associated With Child Terms';
					}
					else {
						show_biocon_col = true;
						data_link = go_details_all_link;
						new_message = 'Hide Genes Associated With Child Terms';
					}
					
					post_json_to_url(data_link, {}, 
						function(data) {  		
  							set_up_evidence_table(header_id, phenotype_header_id, table_id, download_button_id, 
	  							download_table_link, download_table_filename, 
	  							analyze_button_id, analyze_link, bioent_display_name, bioent_format_name, bioent_link, show_biocon_col, data);
  							if(data.length > 0) {
  								document.getElementById(message_id).style.display = "none";
	  							document.getElementById(wrapper_id).style.display = "block";
	  						}
	  						else {
	  							document.getElementById(message_id).style.display = "block";
	  							document.getElementById(wrapper_id).style.display = "none";
	  						}
  							child_button.innerHTML = new_message;
  							$('#' + child_button_id).removeAttr('disabled');
  						},
  						function() {
    						$('#' + child_button_id).removeAttr('disabled');
  						}
  					);
	  				
	  			};
	  			$('#' + child_button_id).removeAttr('disabled');
	  			
	  		});
		}
		else {
			document.getElementById('genes').style.display = "none";
			$.getJSON('http://localhost:6543/phenotype/ontology?callback=?', function(data) {
				var section_id = 'ontology';
				var ontology_list_id = 'full_ontology';
				document.getElementById(section_id).style.display = "block";
				set_up_full_ontology(ontology_list_id, data);
			});
		}
		
  		
  		//Get graph
  		$.getJSON(ontology_graph_link, function(data) {
  			var graph_id = "cy";
  			var section_id = "network";
  			var section_navbar_id = "navbar_network";
  			if(data['nodes'].length > 1) {
  				var cy = setup_cytoscape_vis(graph_id, layout, graph_style, data);
  			}
			else {
				document.getElementById(section_id).style.display = "none";
				document.getElementById(section_navbar_id).style.display = "none";
			}
			
		});
	});
</script>
        

{% endblock scripts %}
