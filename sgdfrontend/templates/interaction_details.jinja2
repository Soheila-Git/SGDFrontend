<!DOCTYPE html>

<title>{{display_name}} Interactions</title>

{% extends "templates/global_layout.jinja2" %}


{% block body %}

<div id="center_title" class="row">
	<h2><span class="gene_name">{{display_name}}/{{format_name}}</span> Physical and Genetic Interactions  <a href="http://www.yeastgenome.org/help/interaction.html" name="top" class="help"><img src="http://www.yeastgenome.org/images/icon_help_circle_dark.png" alt="Help"></a></h2>
</div>


<!-- Includes tabs.html into template -->
{% include "templates/tabs.jinja2" %}

<script>
	var int_tab = document.getElementById('interaction_tab');
	int_tab.id = 'current';
</script>

<!-- Docs nav
================================================== -->
<div class="row">
	<nav id="sidebar" class="small-3 columns">
		<ul data-magellan-expedition="fixed" class="side-nav" id="side-nav-sticky">
			<li id="nav-title"><h5><a href="{{link}}">{{display_name}}/{{format_name}}</a> Interactions</h5></li>
          	<li data-magellan-arrival="summary"><a href="#summary">Interactors Summary</a></li>
			<li data-magellan-arrival="interactions"><a href="#interactions">Interactions</a></li>
			<li data-magellan-arrival="network"><a href="#network">Network Visualization</a></li>
			<li data-magellan-arrival="resources"><a href="#resources">Resources</a></li>
		</ul>
	</nav>
	
	<div class="small-9 columns">  
		
<!-- Summary
================================================== -->
<section id="summary" data-magellan-destination="summary">
	<div class="page-header">
		<p>Genes and proteins that interact with {{display_name}}. See help for information about interaction data.</p>
		<h1>Interactors Summary</h1>
		<div class="panel">
			<div id="venn_diagram"></div>
	
		<div class="button-bar">
			<h5>Analyze</h5>
			<ul class="button-group radius">
				<li><a id="phys" class="small button secondary sgd-icon-venn-physical">Physical</a></li>
				<li><a id="gen" class="small button secondary sgd-icon-venn-genetic">Genetic</a></li>
				<li><a id="phys_gen_intersect" class="small button secondary sgd-icon-venn-intersection">Intersection</a></li>
				<li><a id="phys_gen_union" class="small button secondary sgd-icon-venn-all">All</a></li>
			</ul>
			<ul class="button-group radius">
				<li><a class="small button secondary radius" id="save" download="interaction_venn.png"><i class="icon-picture"></i> PNG</a></li>
			</ul>
		</div>
	</div>
</section>

<!-- Interactions
================================================== -->
<section id="interactions" data-magellan-destination="interactions">
	<div class="page-header">
		<h1>Interactions <span id="evidence_header" class="round secondary label"></span></h1>
		<span>Source: <a href="http://thebiogrid.org/" target="_blank">BioGRID</a></span>
		<span id='evidence_message'></span>
		<br><br>
		<div id='evidence_wrapper'>
			<div class="button-bar">
				<ul class="button-group radius">
					<li><a id="evidence_table_download" class="small button secondary"><i class='icon-download-alt'></i> Download</a></li>
				</ul>
						
				<ul class="button-group radius">
					<li><a id="evidence_table_analyze" class="small button secondary"><i class='icon-briefcase'></i> Analyze</a></li>
				</ul>
			</div>
			
			<table class='table table-striped table-bordered table-condensed' id='evidence_table' width="100%">
			<thead>
  			<tr>
  				<th>Interactor</th>
  				<th>Interactor Systematic Name</th>
  				<th>Interactor</th>
   				<th>Interactor Systematic Name</th>
  				<th>Type</th>
    			<th>Assay</th>
    			<th>Annotation</th>
    			<th>Action</th>
    			<th>Modification</th>
    			<th>Phenotype</th>
    			<th>Source</th>
    			<th>Reference</th>
    			<th>Note</th>
  			</tr>
  			</thead>
			</table>
        </div>
   </div>
</section>

<!-- Network Visualization
================================================== -->
<section id="network" data-magellan-destination="network">
	<div class="page-header">
		<h1>Network Visualization</h1>
		<div class="panel">
			<label for="all_radio">
				<input id="union_radio" type="radio" name="group1" checked> All
				</label>
			<label for="physical_radio">
				<input id="physical_radio" type="radio" name="group1"> Physical
			</label>
			<label for="genetic_radio">
				<input id="genetic_radio" type="radio" name="group1"> Genetic
				</label>
			<label for="both_radio">
				<input id="intersect_radio" type="radio" name="group1"> Intersection
			</label>

			<div id="cy" name="cy" style="width:100%;height:700px"></div>
			<br>
			<h5>Filter Interactions by # of Experiments:</h5>
			<div id='allSlider' class='noUiSlider' style="width:100%"></div>
			<div id='physSlider' class='noUiSlider' style="width:100%"></div>
			<div id='genSlider' class='noUiSlider' style="width:100%"></div>
			<div id='bothSlider' class='noUiSlider' style="width:100%"></div>
			<br>
		</div><!-- .panel -->
    </div>
</section>

<!-- Resources
================================================== -->
<section id="resources" data-magellan-destination="resources">
	<div class="page-header">
		<h1>Resources</h1>
		<ul id='resource_list'>
		</ul>
	</div>
</section>
<br>
<br>
<br>
<br>
<br>
<br>
</div>
</div>
{% endblock body %}

{% block scripts %}
<script src="/static/js/kinetic-v4.3.3.min.js"></script>	
<script src="/static/js/venn.js"></script>
<script src="/static/js/jquery.nouislider.min.js"></script>
<script src="/static/js/cytoscape/cytoscape.min.js"></script>	
<script src="/static/js/cytoscape/arbor.js"></script>	
	
<script>
  	
  	function get_details(row) {
  		var details = row[11];
  		if(details != null) {
  			return '<strong>Note:</strong> ' + details + '<br>';
  	    }
  	    else {
  	    	return null;
  	    }
  	}
  	
  	var ev_table;
  	
  	function set_up_evidence_table(data) { 
  		var datatable = [];
  		for (var i=0; i < data.length; i++) {
  			var evidence = data[i];
  			
  			var bioent1 = create_link(evidence['bioent1']['display_name'], evidence['bioent1']['link'])
			var bioent2 = create_link(evidence['bioent2']['display_name'], evidence['bioent2']['link'])
			
			var experiment = '';
			if(evidence['experiment'] != null) {
  				//experiment = create_link(evidence['experiment']['display_name'], evidence['experiment']['link']);
  				experiment = evidence['experiment']['display_name'];
  			}
  			var phenotype = '';
  			if(evidence['phenotype'] != null) {
  				//phenotype = create_link(evidence['phenotype']['display_name'], evidence['phenotype']['link']);
  				phenotype = evidence['phenotype']['display_name'];
  			}
  			var modification = '';
  			if(evidence['modification'] != null) {
  				modification = evidence['modification'];
  			}
  			var reference = create_link(evidence['reference']['display_name'], evidence['reference']['link']);;
  			datatable.push([bioent1, evidence['bioent1']['format_name'], bioent2, evidence['bioent2']['format_name'], evidence['interaction_type'], experiment, evidence['annotation_type'], evidence['direction'], modification, phenotype, evidence['source'], reference, evidence['note']])
  		}
  		document.getElementById("evidence_header").innerHTML = data.length;
  		         
        var options = {};
		options["bPaginate"] = true;
		options["aaSorting"] = [[1, "asc"]];
		options["aoColumns"] = [{"bSearchable":false, "bVisible":false}, {"bSearchable":false, "bVisible":false}, null, {"bSearchable":false, "bVisible":false}, null, null, null, null, null, null, {"bSearchable":false, "bVisible":false}, null, {"bSearchable":false, "bVisible":false}]		
		options["aaData"] = datatable;
  				
  		ev_table = $('#evidence_table').dataTable(options);
  		
  		document.getElementById("evidence_table_download").onclick = function f() {download_table(ev_table, '/download_table', '{{display_name}}_interaction_details')};
  		document.getElementById("evidence_table_analyze").onclick = analyze_table;
  	}
  	
  	function set_up_overview_table(data) {
  		var r = data['gen_circle_size'];
  		var s = data['phys_circle_size'];
  		var x = data['circle_distance'];
  		var A = data['num_gen_interactors'];
  		var B = data['num_phys_interactors'];
  		var C = data['num_both_interactors'];
  			
  		//Colors chosen as colorblind safe from http://colorbrewer2.org/.
		var stage = draw_venn_diagram("venn_diagram", r, s, x, A, B, C, "762A83", "1B7837");
		stage.toDataURL({
       		width: 350,
        	height: 350,
        	callback: function(dataUrl) {
          		document.getElementById("save").href = dataUrl.replace("image/png", "image/octet-stream");
        	}
        });
			
    	if(r == 0) {
    		document.getElementById("phys_and_gen").disabled = true; 
    		document.getElementById("phys").disabled = true; 
    	}
    	if(s == 0) {
    		document.getElementById("phys_and_gen").disabled = true; 
    		document.getElementById("gen").disabled = true; 
    	}
    	if(x == r+s+1) {
    		document.getElementById("phys_and_gen").disabled = true; 
    	}
    	
    	//set up Analyze buttons
    	document.getElementById("phys").onclick = analyze_phys;
    	document.getElementById("gen").onclick = analyze_gen;
    	document.getElementById("phys_gen_intersect").onclick = analyze_phys_gen_intersect;
    	document.getElementById("phys_gen_union").onclick = analyze_phys_gen_union;
  	}
	
	$(document).ready(function() {
    	//Get overview data
  		$.getJSON("{{interaction_overview_link}}", set_up_overview_table);
	
		//Get evidence data
  		$.getJSON("{{interaction_details_link}}", set_up_evidence_table);
    	
    	//Get resources
	  	$.getJSON("{{interaction_resources_link}}", set_up_resources);
	});

	function analyze_phys_gen_intersect() {
		var bioent_sys_names = [];

		var gen_bioent_sys_names = {};
		var data = ev_table.fnGetData();
		for (var i=0,len=data.length; i<len; i++) { 
			var ev_type = data[i][4];
			if(ev_type == 'Genetic') {
				var sys_name = data[i][3];
				gen_bioent_sys_names[sys_name] = true;
			}
		}	

		for (var i=0,len=data.length; i<len; i++) { 
			var ev_type = data[i][4];
			if(ev_type == 'Physical') {
				var sys_name = data[i][3];
				if(sys_name in gen_bioent_sys_names) {
					bioent_sys_names.push(sys_name);
				}
			}

		}	
		post_to_url('{{analyze_link}}', {'bioent_display_name': '{{display_name}}', 'bioent_format_name': '{{format_name}}', 'bioent_link': '{{link}}', 
										'bioent_ids': bioent_sys_names, 'list_type': 'Intersection Interactors'});
	}
	
	function analyze_phys() {
		var bioent_sys_names = [];

		var data = ev_table.fnGetData();
		for (var i=0,len=data.length; i<len; i++) { 
			var ev_type = data[i][4];
			if(ev_type == 'Physical') {
				var sys_name = data[i][3];
				bioent_sys_names.push(sys_name);
			}
		}	
		post_to_url('{{analyze_link}}', {'bioent_display_name': '{{display_name}}', 'bioent_format_name': '{{format_name}}', 'bioent_link': '{{link}}', 
										'bioent_ids': bioent_sys_names, 'list_type': 'Physical Interactors'});
	}
	
	function analyze_gen() {
		var bioent_sys_names = [];

		var data = ev_table.fnGetData();
		for (var i=0,len=data.length; i<len; i++) { 
			var ev_type = data[i][4];
			if(ev_type == 'Genetic') {
				var sys_name = data[i][3];
				bioent_sys_names.push(sys_name);
			}
		}	
		post_to_url('{{analyze_link}}', {'bioent_display_name': '{{display_name}}', 'bioent_format_name': '{{format_name}}', 'bioent_link': '{{link}}',
										 'bioent_ids': bioent_sys_names, 'list_type': 'Genetic Interactors'});
	}
	
	function analyze_phys_gen_union() {
		var bioent_sys_names = [];

		var data = ev_table.fnGetData();
		for (var i=0,len=data.length; i<len; i++) { 
			var sys_name = data[i][3];
			bioent_sys_names.push(sys_name);
		}	
		post_to_url('{{analyze_link}}', {'bioent_display_name': '{{display_name}}', 'bioent_format_name': '{{format_name}}', 'bioent_link': '{{link}}',
										 'bioent_ids': bioent_sys_names, 'list_type': 'Interactors'});
	}
	
	function analyze_table() {
		var bioent_sys_names = [];

		var data = ev_table._('tr', {"filter": "applied"});
		for (var i=0,len=data.length; i<len; i++) { 
			var sys_name = data[i][3];
			bioent_sys_names.push(sys_name);
		}	
		
		var list_type = 'Interactors'
		var search_term = ev_table.fnSettings().oPreviousSearch.sSearch
		if(search_term != '') {
			list_type = list_type + ' filtered by "' + search_term + '"'
		}
			
		post_to_url('{{analyze_link}}', {'bioent_display_name': '{{display_name}}', 'bioent_format_name': '{{format_name}}', 'bioent_link': '{{link}}',
										 'bioent_ids': bioent_sys_names, 'list_type': list_type});
	}
	
</script>

<script>
var style = cytoscape.stylesheet()
	.selector('node')
	.css({
		'content': 'data(name)',
		'font-family': 'helvetica',
		'font-size': 14,
		'text-outline-width': 3,
		'text-outline-color': '#888',
		'text-valign': 'center',
		'color': '#fff',
		'width': 30,
		'height': 30,
		'border-color': '#fff'
	})
	.selector('edge')
	.css({
		'width': 2,
	})
	.selector("node[sub_type='FOCUS']")
	.css({
		'background-color': "#fade71",
		'text-outline-color': '#fff',
		'color': '#888',
	})
	.selector("edge[genetic > 0][physical = 0]")
	.css({
		'line-color': "#7FBF7B",
	})
	.selector("edge[physical > 0][genetic = 0]")
	.css({
		'line-color': "#AF8DC3",
	})
	.selector("edge[genetic > 0][physical > 0]")
	.css({
		'line-color': "black",
	});


$.getJSON("{{interaction_graph_link}}", function(data) {
	setup_cytoscape_vis('cy', style, data);
	
	
	setup_slider("allSlider", data['min_evidence_cutoff'], Math.min(data['max_evidence_cutoff'], 10), Math.min(data['max_evidence_cutoff'], 3), filter_cy);
	setup_slider("physSlider", data['min_evidence_cutoff'], Math.min(data['max_phys_cutoff'], 10), Math.min(data['max_phys_cutoff'], 3), filter_cy);
	setup_slider("genSlider", data['min_evidence_cutoff'], Math.min(data['max_gen_cutoff'], 10), Math.min(data['max_gen_cutoff'], 3), filter_cy);
	setup_slider("bothSlider", data['min_evidence_cutoff'], Math.min(data['max_both_cutoff'], 10), Math.min(data['max_both_cutoff'], 3), filter_cy);
	
	document.getElementById("physSlider").style.display = 'none';
	document.getElementById("genSlider").style.display = 'none';
	document.getElementById("bothSlider").style.display = 'none';
	
	if(data['max_phys_cutoff'] == 0) {
		document.getElementById("physical_radio").disabled = true;
	}
	if(data['max_gen_cutoff'] == 0) {
		document.getElementById("genetic_radio").disabled = true;
	}
	if(data['max_both_cutoff'] == 0) {
		document.getElementById("intersect_radio").disabled = true;
	}
	
	document.getElementById('physical_radio').onclick = function f() {change_scale(); filter_cy()}
	document.getElementById('genetic_radio').onclick = function f() {change_scale(); filter_cy()}
	document.getElementById('intersect_radio').onclick = function f() {change_scale(); filter_cy()}
	document.getElementById('union_radio').onclick = function f() {change_scale(); filter_cy()}
});

function change_scale() {
	var all = document.getElementById('union_radio').checked;
	var phys = document.getElementById('physical_radio').checked;
	var gen = document.getElementById('genetic_radio').checked;
	var both = document.getElementById('intersect_radio').checked;
	
	var prev_value;
	if(document.getElementById("allSlider").style.display == 'block') {
		prev_value = $("#allSlider").val();
	}
	else if(document.getElementById("physSlider").style.display == 'block') {
		prev_value = $("#physSlider").val();
	}
	else if(document.getElementById("genSlider").style.display == 'block') {
		prev_value = $("#genSlider").val();
	}
	else if(document.getElementById("bothSlider").style.display == 'block') {
		prev_value = $("#bothSlider").val();
	}
	
	if(all) {
		$("#allSlider").val(prev_value);
		document.getElementById("allSlider").style.display = 'block';
		document.getElementById("physSlider").style.display = 'none';
		document.getElementById("genSlider").style.display = 'none';
		document.getElementById("bothSlider").style.display = 'none';
	}
	else if(phys) {
		$("#physSlider").val(prev_value);
		document.getElementById("allSlider").style.display = 'none';
		document.getElementById("physSlider").style.display = 'block';
		document.getElementById("genSlider").style.display = 'none';
		document.getElementById("bothSlider").style.display = 'none';
	}
	else if(gen) {
		$("#genSlider").val(prev_value);
		document.getElementById("allSlider").style.display = 'none';
		document.getElementById("physSlider").style.display = 'none';
		document.getElementById("genSlider").style.display = 'block';
		document.getElementById("bothSlider").style.display = 'none';
	}
	else if(both) {
		$("#bothSlider").val(prev_value);
		document.getElementById("allSlider").style.display = 'none';
		document.getElementById("physSlider").style.display = 'none';
		document.getElementById("genSlider").style.display = 'none';
		document.getElementById("bothSlider").style.display = 'block';
	}
}

function filter_cy() {
	var all = document.getElementById('union_radio').checked;
	var phys = document.getElementById('physical_radio').checked;
	var gen = document.getElementById('genetic_radio').checked;
	var both = document.getElementById('intersect_radio').checked;
	
    if(all) {
    	var cutoff = $("#allSlider").val();
        cy.elements("node[evidence >= " + cutoff + "]").css({'visibility': 'visible',});
        cy.elements("edge[evidence >= " + cutoff + "]").css({'visibility': 'visible',});
        
        cy.elements("node[evidence < " + cutoff + "]").css({'visibility': 'hidden',});
        cy.elements("edge[evidence < " + cutoff + "]").css({'visibility': 'hidden',});
    }
    else if(phys) {
        var cutoff = $("#physSlider").val();
        cy.elements("node[physical >=  " + cutoff + "]").css({'visibility': 'visible',});
        cy.elements("edge[physical >=  " + cutoff + "]").css({'visibility': 'visible',});
        
        cy.elements("node[physical < " + cutoff + "]").css({'visibility': 'hidden',});
        cy.elements("edge[physical < " + cutoff + "]").css({'visibility': 'hidden',});
    }
    else if(gen) {
    	var cutoff = $("#genSlider").val();
        cy.elements("node[genetic >= " + cutoff + "]").css({'visibility': 'visible',});
        cy.elements("edge[genetic >= " + cutoff + "]").css({'visibility': 'visible',});
        
        cy.elements("node[genetic < " + cutoff + "]").css({'visibility': 'hidden',});
        cy.elements("edge[genetic < " + cutoff + "]").css({'visibility': 'hidden',});
    }
    else if(both) {
    	var cutoff = $("#bothSlider").val();
        cy.elements("node[physical >= " + cutoff + "][genetic >= " + cutoff + "]").css({'visibility': 'visible',});
        cy.elements("edge[physical >= " + cutoff + "][genetic >= " + cutoff + "]").css({'visibility': 'visible',});
        
        cy.elements("node[physical < " + cutoff + "]").css({'visibility': 'hidden',});
        cy.elements("edge[physical < " + cutoff + "]").css({'visibility': 'hidden',});
        
        cy.elements("node[genetic < " + cutoff + "]").css({'visibility': 'hidden',});
        cy.elements("edge[genetic < " + cutoff + "]").css({'visibility': 'hidden',});
    }
}
</script>
        

{% endblock scripts %}
